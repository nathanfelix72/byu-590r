name: BYU 590R Deploy

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  test-frontend:
    name: Frontend Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: web-app/package-lock.json

      - name: Install dependencies
        run: |
          cd web-app
          npm install

      - name: Run tests
        run: |
          cd web-app
          npm run test -- --watch=false --browsers=ChromeHeadless

      - name: Build
        run: |
          cd web-app
          npm run build

  test-backend:
    name: Backend Tests
    runs-on: ubuntu-latest
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: byu_590r_app_test
          MYSQL_USER: byu_user
          MYSQL_PASSWORD: byu_password
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - uses: actions/checkout@v4

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.3"
          extensions: mbstring, dom, fileinfo, mysql
          coverage: none
          # Composer is installed by default; no curl to getcomposer.org

      - name: Install dependencies
        run: |
          cd backend
          set +e
          composer install --no-interaction --no-scripts --prefer-dist
          EXIT=$?
          set -e
          # If lock file is incompatible with PHP 8.3 (e.g. has Symfony 8), run update so Composer resolves for platform
          if [ $EXIT -ne 0 ]; then
            composer update --no-interaction --no-scripts --prefer-dist
          fi

      - name: Configure .env for tests
        run: |
          cd backend
          cp .env.example .env
          php artisan key:generate --no-interaction
          sed -i 's/DB_CONNECTION=.*/DB_CONNECTION=mysql/' .env
          sed -i 's/DB_HOST=.*/DB_HOST=127.0.0.1/' .env
          sed -i 's/DB_PORT=.*/DB_PORT=3306/' .env
          sed -i 's/DB_DATABASE=.*/DB_DATABASE=byu_590r_app_test/' .env
          sed -i 's/DB_USERNAME=.*/DB_USERNAME=byu_user/' .env
          sed -i 's/DB_PASSWORD=.*/DB_PASSWORD=byu_password/' .env
          # Override with secrets if set
          if [ -n "${{ secrets.DB_DATABASE }}" ]; then sed -i "s/DB_DATABASE=.*/DB_DATABASE=${{ secrets.DB_DATABASE }}_test/" .env; fi
          if [ -n "${{ secrets.DB_USERNAME }}" ]; then sed -i "s/DB_USERNAME=.*/DB_USERNAME=${{ secrets.DB_USERNAME }}/" .env; fi
          if [ -n "${{ secrets.DB_PASSWORD }}" ]; then sed -i "s/DB_PASSWORD=.*/DB_PASSWORD=${{ secrets.DB_PASSWORD }}/" .env; fi

      - name: Run tests
        run: |
          cd backend
          php artisan test

  deploy-to-ec2:
    name: Deploy to EC2
    needs: [test-frontend, test-backend]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v4

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}

      - name: Deploy backend
        run: |
          ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_HOST }} "sudo mkdir -p /var/www/html/api && sudo chown -R ubuntu:ubuntu /var/www/html/api"
          rsync -avz --delete -e "ssh -o StrictHostKeyChecking=no" \
            backend/ ubuntu@${{ secrets.EC2_HOST }}:/var/www/html/api/

          # If EC2 has no Composer (user_data failed or instance not from Terraform), provide composer.phar from runner
          for i in 1 2 3; do
            curl -sS -L --connect-timeout 60 -o composer.phar https://getcomposer.org/download/latest-stable/composer.phar && break
            [ $i -eq 3 ] && exit 1
            echo "Retry $i/3 in 10s..." && sleep 10
          done
          scp -o StrictHostKeyChecking=no composer.phar ubuntu@${{ secrets.EC2_HOST }}:/var/www/html/api/

          ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_HOST }} << 'REMOTE'
          set -e
          export PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:$PATH"
          cd /var/www/html/api

          # Resolve PHP (non-interactive SSH often has minimal PATH)
          PHP_BIN=$(command -v php 2>/dev/null || true)
          [ -z "$PHP_BIN" ] && [ -x /usr/bin/php8.3 ] && PHP_BIN=/usr/bin/php8.3
          [ -z "$PHP_BIN" ] && [ -x /usr/bin/php8.1 ] && PHP_BIN=/usr/bin/php8.1
          [ -z "$PHP_BIN" ] && [ -x /usr/bin/php ] && PHP_BIN=/usr/bin/php
          if [ -z "$PHP_BIN" ]; then
            echo "ERROR: PHP not found. Ensure EC2 was provisioned with Terraform user_data (installs php8.3)."
            exit 1
          fi

          # Use Composer: system (from Terraform user_data) or composer.phar copied from runner
          if command -v composer >/dev/null 2>&1; then
            COMPOSER_CMD=composer
          elif [ -f composer.phar ]; then
            COMPOSER_CMD="$PHP_BIN composer.phar"
          else
            echo "ERROR: Composer not found and composer.phar was not copied."
            exit 1
          fi

          # .env: create from example if needed, then apply secrets (DB_CONNECTION=mysql required on server; Laravel defaults to sqlite otherwise)
          if [ ! -f .env ]; then
            cp .env.example .env
          fi
          grep -q '^DB_CONNECTION=' .env && sed -i 's/^DB_CONNECTION=.*/DB_CONNECTION=mysql/' .env || echo 'DB_CONNECTION=mysql' >> .env
          sed -i 's/^DB_HOST=.*/DB_HOST=localhost/' .env
          sed -i 's/^DB_PORT=.*/DB_PORT=3306/' .env
          sed -i "s/^DB_DATABASE=.*/DB_DATABASE=${DB_DATABASE:-byu_590r_app}/" .env
          sed -i "s/^DB_USERNAME=.*/DB_USERNAME=${DB_USERNAME:-byu_user}/" .env
          sed -i "s/^DB_PASSWORD=.*/DB_PASSWORD=${DB_PASSWORD:-byu_password}/" .env
          sed -i 's/^APP_ENV=.*/APP_ENV=production/' .env

          # Install PHP dependencies; if lock file targets PHP 8.4 (Symfony 8) but server has 8.3, run update
          set +e
          $COMPOSER_CMD install --no-interaction --no-scripts --prefer-dist --no-dev --optimize-autoloader
          EXIT=$?
          set -e
          if [ $EXIT -ne 0 ]; then
            $COMPOSER_CMD update --no-interaction --no-scripts --prefer-dist --no-dev --optimize-autoloader
          fi

          $PHP_BIN artisan key:generate --force 2>/dev/null || true
          $PHP_BIN artisan config:clear
          sudo mkdir -p storage/framework/{cache,sessions,views} storage/logs storage/app bootstrap/cache
          sudo chown -R ubuntu:www-data /var/www/html/api
          sudo chmod -R 775 storage bootstrap/cache
          echo "Backend deps and dirs done."
          REMOTE

      - name: Inject backend .env secrets
        run: |
          ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_HOST }} "cd /var/www/html/api && \
            (grep -q '^DB_DATABASE=' .env && sed -i 's/^DB_DATABASE=.*/DB_DATABASE=${{ secrets.DB_DATABASE }}/' .env || echo 'DB_DATABASE=${{ secrets.DB_DATABASE }}' >> .env); \
            (grep -q '^DB_USERNAME=' .env && sed -i 's/^DB_USERNAME=.*/DB_USERNAME=${{ secrets.DB_USERNAME }}/' .env || echo 'DB_USERNAME=${{ secrets.DB_USERNAME }}' >> .env); \
            (grep -q '^DB_PASSWORD=' .env && sed -i 's/^DB_PASSWORD=.*/DB_PASSWORD=${{ secrets.DB_PASSWORD }}/' .env || echo 'DB_PASSWORD=${{ secrets.DB_PASSWORD }}' >> .env); \
            (grep -q '^FILESYSTEM_DISK=' .env && sed -i 's/^FILESYSTEM_DISK=.*/FILESYSTEM_DISK=s3/' .env || echo 'FILESYSTEM_DISK=s3' >> .env); \
            (grep -q '^S3_BUCKET=' .env && sed -i 's|^S3_BUCKET=.*|S3_BUCKET=${{ secrets.S3_BUCKET }}|' .env || echo 'S3_BUCKET=${{ secrets.S3_BUCKET }}' >> .env); \
            (grep -q '^S3_BUCKET_PROD=' .env && sed -i 's|^S3_BUCKET_PROD=.*|S3_BUCKET_PROD=${{ secrets.S3_BUCKET }}|' .env || echo 'S3_BUCKET_PROD=${{ secrets.S3_BUCKET }}' >> .env); \
            (grep -q '^AWS_ACCESS_KEY_ID=' .env && sed -i 's/^AWS_ACCESS_KEY_ID=.*/AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}/' .env || echo 'AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}' >> .env); \
            (grep -q '^AWS_SECRET_ACCESS_KEY=' .env && sed -i 's/^AWS_SECRET_ACCESS_KEY=.*/AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}/' .env || echo 'AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}' >> .env); \
            (grep -q '^AWS_DEFAULT_REGION=' .env && sed -i 's/^AWS_DEFAULT_REGION=.*/AWS_DEFAULT_REGION=${{ secrets.AWS_REGION }}/' .env || echo 'AWS_DEFAULT_REGION=${{ secrets.AWS_REGION }}' >> .env); \
            ([ -z '${{ secrets.APP_DEBUG }}' ] || (grep -q '^APP_DEBUG=' .env && sed -i 's/^APP_DEBUG=.*/APP_DEBUG=${{ secrets.APP_DEBUG }}/' .env || echo 'APP_DEBUG=${{ secrets.APP_DEBUG }}' >> .env)); \
            ([ -z '${{ secrets.OPENAI_API_KEY }}' ] || (grep -q '^OPENAI_API_KEY=' .env && sed -i 's|^OPENAI_API_KEY=.*|OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}|' .env || echo 'OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}' >> .env)); \
            true"

      - name: Migrate and restart backend
        run: |
          ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_HOST }} "export PATH=/usr/bin:/usr/local/bin:\$PATH && cd /var/www/html/api && php artisan config:clear && php artisan migrate --force && php artisan migrate --seed --force 2>/dev/null || true && sudo systemctl restart apache2"

      - name: Deploy frontend
        run: |
          # Inject Terraform-generated EC2 host into production environment (from GitHub secret EC2_HOST)
          sed -i "s|__EC2_HOST__|${{ secrets.EC2_HOST }}|g" web-app/src/environments/environment.prod.ts
          cd web-app
          npm install
          npm run build

          ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_HOST }} "sudo mkdir -p /var/www/html/app && sudo chown -R ubuntu:ubuntu /var/www/html/app"
          rsync -avz --delete -e "ssh -o StrictHostKeyChecking=no" \
            dist/byu-590r-builder/ ubuntu@${{ secrets.EC2_HOST }}:/var/www/html/app/
          ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_HOST }} "sudo chown -R www-data:www-data /var/www/html/app && sudo systemctl reload apache2"

      - name: Verify
        run: |
          sleep 5
          ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_HOST }} "curl -s -o /dev/null -w '%{http_code}' http://localhost/ && echo ' Frontend' && curl -s -o /dev/null -w '%{http_code}' http://localhost:4444/api/hello && echo ' Backend'"

  test-deployment:
    name: Post-deploy tests
    needs: [deploy-to-ec2]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "18"
      - run: npm install -D @playwright/test @types/node && npx playwright install --with-deps chromium
      - name: Run Playwright
        env:
          BACKEND_URL: http://${{ secrets.EC2_HOST }}:4444
          FRONTEND_URL: http://${{ secrets.EC2_HOST }}
        run: npx playwright test --reporter=list,html
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7

  deploy-complete:
    name: Done
    needs: [test-deployment]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - run: |
          echo "Frontend http://${{ secrets.EC2_HOST }}"
          echo "Backend  http://${{ secrets.EC2_HOST }}:4444/api/hello"
